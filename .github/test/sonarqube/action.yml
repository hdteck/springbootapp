name: sonarqube tests
description: test de sonarqube
runs:
 using: "composite"
 steps:
  - name: SonarQube Scan
    run: mvn clean package sonar:sonar -Dsonar.projectKey=spring-boot-demoapp -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml -Dsonar.host.url=$SONAR_URL -Dsonar.login=$SONAR_TOKEN
    shell: bash
  - name: Sonar qualityGate
    run: mvn sonar-quality-gate:check -Dsonar.qualitygate.wait=true -Dsonar.projectKey=springboot-demoapp -Dsonar.host.url=$SONAR_URL -Dsonar.login=$SONAR_TOKEN
    continue-on-error: true
    shell: bash
  - name: qualityGate status
    run: |
        analysisID=`cat target/sonar/report-task.txt |grep ceTaskId |awk -F= '{ print $2 }'`
        qualityGateStatus="$(curl --location  --max-redirs 10 --silent --fail --show-error --user "$SONAR_TOKEN": "$SONAR_URL/api/qualitygates/project_status?analysisId=$analysisID" | jq -r '.projectStatus.status')"
        if [[ ${qualityGateStatus} == "ERROR" ]]; then
        echo "Quality Gate FAILED"
        git merge --no-ff master -m "Auto-merge master back to dev"
        fi
    shell: bash