name: sonarqube tests
description: test de sonarqube
runs:
 using: "composite"
 steps:
  - name: SonarQube Scan
    run: mvn clean package sonar:sonar -Dsonar.projectKey=springbootapp -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml -Dsonar.host.url=$SONAR_URL -Dsonar.login=$SONAR_TOKEN
    shell: bash
  - name: Sonar qualityGate
    run: mvn sonar-quality-gate:check -Dsonar.qualitygate.wait=true -Dsonar.projectKey=springbootapp -Dsonar.host.url=$SONAR_URL -Dsonar.login=$SONAR_TOKEN
    continue-on-error: true
    shell: bash
  - name: qualityGate status
    run: |
        cat target/sonar/report-task.txt |grep ceTaskId |awk -F= '{ print $2 }'
        echo $analysisID
        if [[ ${qualityGateStatus} == "ERROR" ]]; then
        echo "Quality Gate FAILED"
        git merge --no-ff master -m "Auto-merge master back to dev"
        fi
    shell: bash